---
title: "Jumping on the Bandwagon"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This post is the first in a two-part series on AFL crowds. This analysis will be a thorough look at AFL crowd numbers over the last 20 years, and will concern itself with discovering whose teams fans are the biggest bandwagon jumpers. *Bandwagon Jumpers* are those fans that are the loudest in the office or in your friendship group when things are going well, and the quietest when their team is losing.

People all have their theories on which team's fans are the worst offending bandwagoners; this analysis will try to answer it once and for all! Also, sefishly, I'm sick of people telling me that fans of my team - the Hawthorn Hawks (a team that has experienced tremendous success over the last 10 years) are the worst offenders.

## The Data
Data was collected from a few different online sources. The game and attendance data was sourced from the amazing [AFL Tables](https://afltables.com), while the betting data was sourced from the [Australian Sports Betting](http://www.aussportsbetting.com) website. 

***

```{r}
library(tidyverse)
library(scales)

theme_set(theme_minimal() +
            theme(panel.grid = element_blank(),
                  plot.title = element_text(size = 18, colour = "darkred"),
                  axis.title.x = element_text(size = 14, colour = "darkred", hjust = 1),
                  axis.title.y = element_text(size = 14, colour = "darkred"),
                  axis.text.x = element_text(size = 12),
                  axis.text.y = element_text(size = 12)))

```


```{r}
afl <- readRDS("data/cleaned_data/game_weather_betting_data.rds")

afl <- afl %>% 
  mutate(team1 = ifelse(team1 == "Kangaroos", "North Melbourne", team1),
         team2 = ifelse(team2 == "Kangaroos", "North Melbourne", team2))

afl_premiership_season <- afl %>% filter(!str_detect(round, "Final"))
```

Over the last 20 years, the median (the 50% mark and a better measure than the average on skewed data) crowd to AFL games was just over 33,500. The data is positively skewed with a tail that extends out to 100,000. 

```{r}
afl %>% 
  mutate(is_finals = ifelse(str_detect(round, "Final"), "Finals", "Regular")) %>% 
  ggplot(aes(x=attendance)) +
  geom_histogram(colour = "midnightblue", fill = "steelblue") +
  scale_x_continuous(labels = comma, name = "Attendance") +
  labs(y= "Number of Games", title = "SOME LARGER DRAWING GAMES SKEWING DATA SLIGHTLY") +
  geom_vline(xintercept = median(afl$attendance), linetype = 2, colour = "darkred", size = 0.5) +
  geom_text(aes(label = paste0("Median Crowd: ", comma(median(afl$attendance))), x= median(afl$attendance) + 15000), y= 350, colour = "darkred") +
  ylim(0,400) +
  theme(panel.grid.major.y = element_line(linetype = 2, colour = "lightgrey"))
```

Thankfully for the AFL, the finals series at the end of the season draws larger crowds than the premiership (regular season for non-AFL fans) season. The median attendance for the premiership season is just over 33,000, while for finals it is over 58,000. The finals series are the flagship games for the AFL - they would hope these games would draw larger crowds. 

```{r}
afl %>% 
  mutate(is_finals = ifelse(str_detect(round, "Final"), "Finals", "Regular")) %>% 
  group_by(is_finals) %>% 
  summarise(median(attendance))

afl %>% 
  mutate(is_finals = ifelse(str_detect(round, "Final"), "Finals", "Regular")) %>% 
  ggplot(aes(x= is_finals, y= attendance)) +
  geom_boxplot(colour = "midnightblue", fill = "steelblue") +
  scale_y_continuous(labels = comma, name = "Attendance") +
  ggtitle("FINALS DRAW LARGER CROWDS... THANKFULLY") +
  theme(axis.title.x = element_blank(), panel.grid.major.y = element_line(linetype = 2, colour = "lightgrey"))


```

The rest of the analysis will only focus on the premiership season.


The last 20 seasons have seen some peaks and throughs though, with median attendances ranging from just under 29,000 in 2012 to just over 36,800 in 2008. The low attendances in 2012-13 was no doubt fuelled by the introduction of the newest expansion teams - Gold Coast and Greater Western Sydney (GWS) - in regions that are traditionally not AFL strongholds. The last five years however have seen a rebound of sorts, as these clubs slowly build up fanbases (and in the case of GWS start to have some success).

```{r}
afl_premiership_season %>% 
  filter(season < 2019) %>% 
  group_by(season) %>%
  summarise(median_attendance = median(attendance)) %>% 
  ggplot(aes(x= season, y= median_attendance, group = 1)) +
  geom_line() +
  geom_point() +
  labs(x= "Season", y= "Median\nAttendance", title = "PREMIERSHIP SEASON MEDIAN ATTENDANCES", subtitle = "Current 2019 season excluded") +
  scale_y_continuous(labels = comma) +
  annotate("text", x=2013, y= 28500, label = "The introduction of Gold Coast and GWS\nreally hurt attendances in 2012/13") +
  theme(plot.subtitle = element_text(colour = "darkred"))
```


# Which teams draw larger attendances

So what about the age old question asked around the water cooler... who has more fans?

Well this post won't be able to answer that question. What it can answer is which teams's fans attend games in greater numbers?

There are seven teams that have had above average crowds since the 2000 season:

* Adelaide
* Carlton
* Collingwood
* Essendon
* Hawthorn
* Richmond
* West Coast

Four of those clubs are Victorian clubs, with the other two from South Australia and Western Australia. This is important to note that even though the AFL is a national competition, these three states are traditionally stronghold states. Brisbane - despite their extreme success in the early part of this century and the fact that a Victorian club merged with then (Fitzroy Lions) - have the third lowest attendances. Only recent expansion teams GWS and Gold Coast have lower attendances. The north-east states are clearly a problem for the league.

```{r}
team_attendances <- afl_premiership_season %>% 
  select(Team = team1, round, season, venue, date, game_time, winner, attendance, last_result = team1_last_result) %>% 
  mutate(home_or_away = "Home") %>% 
  union(afl_premiership_season %>% 
          select(Team = team2, round, season, venue, date, game_time, winner, attendance, last_result = team2_last_result) %>% 
          mutate(home_or_away = "Away"))
  
median_attendance_overall <- median(afl_premiership_season$attendance)


team_attendances %>% 
  group_by(Team) %>% 
  mutate(median_attendance = median(attendance)) %>% ungroup() %>%
  mutate(above_average = ifelse(median_attendance > median_attendance_overall, "Above Average", "Below Average")) %>% 
  ggplot(aes(x= Team, y= attendance, fill = above_average)) +
  geom_boxplot() +
  geom_hline(data = afl_premiership_season, aes(yintercept = median(attendance)), colour = "darkred", size = 1, linetype = 2) +
  coord_flip() +
  scale_y_continuous(labels = comma, name = "Attendance") +
  scale_fill_manual(values = c("steelblue", "lightgrey")) +
  ggtitle("ATTENDANCES FOR EACH TEAM OVER THE LAST 20 YEARS") +
  theme(axis.title.y = element_blank(), legend.position = "none")
  
```


# Last Week's Performance Impact

To answer this question, we can look at the difference in attendance for each team the next game after a win or a loss. A few things to note using this method:

1. Round one games have been excluded as the previous game was the last season and there's too much noise using that
2. The difference was calculated taking the median attendance after either a win or loss and comparing that against the team's overall median attendance for the season.

First thing we can do is visualise the data. Using boxplots to show the team's distribution of attendances for games wither after a win or loss, we can see that there are what appear to be considerable differences for some teams. Where the line in the middle of the box (the median) differs noticably between a win or loss the previous week is an indication that that team's supporters may be less inclined to attend their team's games after a loss (or more inclined after a win).

Hmmm well that certainly doesn't help my case. Hawthorn's losing attendance impact (LAI) is 11%, meaning that Hawthorn fan attendance at games after a loss is 11% lower than their season median attendance. Only GWS have a worse LAI at 16.9% difference. Of the four traditionally big supporter based clubs in Victoria (Carlton, Collingwood, Essendon, Richmond), Collingwood fans are the worst at not showing up a week after a loss, with a 7.5% LAI, while Essendon fans are the most resillient of this bunch (1.9% LAI). So much for Richmond fans telling me they're the most resillient.

At the other end of the Spectrum, West Coast supporters turn up in virtually the same numbers on average wiht an LAI of 0.6%, while the Western Bulldogs have an LAI of 0.9% (albeit at a much lower base than West Coast).

```{r}
team_attendances %>% 
  filter(!is.na(last_result)) %>% 
  ggplot(aes(y= attendance, x = last_result, fill= last_result)) +
  geom_boxplot() +
  scale_fill_manual(values = c("lightgrey", "steelblue")) +
  facet_wrap(~ Team, scales = "free", ncol = 6) +
  theme(legend.position = "none", strip.text = element_text(size = 12, face = "bold"), strip.background = element_rect(color="black", fill="#FFFFCC", size=1.5, linetype="solid"))




team_attendances %>% 
  filter(!is.na(last_result)) %>% 
  group_by(Team) %>% 
  mutate(median_overall_attendance = median(attendance)) %>% 
  group_by(Team, last_result, median_overall_attendance) %>% 
  summarise(median_attendances = median(attendance)) %>% 
  spread(key = last_result, value = median_attendances) %>% 
  mutate(LossDiff = round((Lost - median_overall_attendance) / median_overall_attendance, 4),
         WinDiff = round((Won - median_overall_attendance) / median_overall_attendance, 4),
         WinLossDiff = (Won - Lost) / Lost) %>% DT::datatable()
```


# Finals Last Season Impact




# Team Favoured To Win Impact





