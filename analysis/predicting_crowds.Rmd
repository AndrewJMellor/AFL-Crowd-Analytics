---
title: "Predicting AFL Crowds"
author: "Jason Zivkovic"
date: "15/06/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
afl <- readRDS("data/cleaned_data/game_weather_betting_data.rds")

afl_pre_2019 <- afl %>% filter(season < 2019) %>% filter(!str_detect(round, "Final"))

afl_pre_2019 <- afl_pre_2019 %>% mutate(odds_diff = abs(HomeOdds - AwayOdds),
                                        rain = ifelse(actual_days_rain > 2, "Yes", "No"),
                                        HomeTeamFav = ifelse(HomeOdds > AwayOdds, "Yes", "No"))

```


The baseline model using OLS, with team1 + team2 + round + venue + start_time as the independant variables is below. The model explains 73% of the variability in crowds. Let's see if this can improve.

```{r}
fit_lm <- lm(attendance ~ team1 + team2 + round + venue + start_time, data = afl_pre_2019)

summary(fit_lm)
```


By using the day of the week the game was played and whether it was a day, evening or night game, the variation explained has been able to increase to 74%.
```{r}
fit_lm2 <- lm(attendance ~ team1 + team2 + round + venue + weekday + time_period, data = afl_pre_2019)

summary(fit_lm2)

```



The R^2 of the model increases to 79% when the difference between the home and away team's opening head-to-head odds, the closing line of the game and whether there was more than 2ml of rain.
```{r}
fit_lm3 <- lm(attendance ~ team1 + team2 + round + venue + weekday + time_period + odds_diff + abs(HomeLineOpen) + rain, data = afl_pre_2019)

summary(fit_lm3)

```


```{r}
fit_lm4 <- lm(attendance ~ team1 + team2 + round + venue + weekday + time_period + odds_diff + abs(HomeLineOpen) + rain + HomeTeamFav, data = afl_pre_2019)

summary(fit_lm4)


```



Including a variable for rivalry game and removing the "rain" variable sees the model's explainability increase to 82%...

```{r}
fit_lm5 <- lm(attendance ~ team1 + team2 + round + venue + weekday + time_period + odds_diff + abs(HomeLineOpen) + HomeTeamFav + rivalry_game, data = afl_pre_2019)

summary(fit_lm5)


```













```{r}
afl %>% filter(season > 2013) %>% View()
```









```{r}
afl_pre_2019 %>% group_by(VenueCity) %>% 
  summarise(n_games = n(), 
            n_missing_weather = sum(is.na(actual_days_rain)), 
            med_rainfall = median(actual_days_rain, na.rm = T),
            rain_games = sum(actual_days_rain > 1, na.rm = T))


afl %>% filter(actual_days_rain > 0) %>% ggplot(aes(x=1, y=actual_days_rain)) + geom_boxplot()


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#---------- ANALYSIS ----------#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

afl %>% 
  count(winner) %>% 
  mutate(prop = n / sum(n))


all_data_cleaned %>% 
  mutate(margin = abs(margin)) %>% 
  ggplot(aes(x= margin)) +
  geom_density()


summary(abs(all_data_cleaned$margin))


mosaic::favstats(abs(all_data_cleaned$margin) ~ all_data_cleaned$season)


all_data_cleaned %>% 
  group_by(season) %>% 
  summarise(median_margin = median(abs(margin)),
            avg_margin = mean(abs(margin))) %>% 
  ggplot(aes(x= season)) +
  geom_line(aes(y= median_margin))



all_data_cleaned %>% 
  filter(round <= 11) %>% 
  group_by(season) %>% 
  summarise(median_attendance = median(attendance)) %>% 
  ggplot(aes(x= season)) +
  geom_line(aes(y= median_attendance))






all_data_cleaned %>% 
  filter(round <= 11) %>% 
  group_by(season) %>% 
  summarise(avg_total_score = mean(total_score)) %>% 
  ggplot(aes(x= season)) +
  geom_line(aes(y= avg_total_score))




all_data_cleaned %>% ggplot() +
  geom_density(aes(x=team1_score), fill = "blue", alpha = 0.5) +
  geom_density(aes(x= team2_score), fill = "green", alpha = 0.5)

```

